# Campaigns

This document describes the campaign system in the Outlier backend application, including how to create, manage, and track campaigns.

## Overview

Campaigns allow you to send scheduled text messages to targeted audience segments or custom recipient lists. Unlike regular broadcasts, campaigns are one-time events scheduled for a specific future date and time.

## Campaign Features

- **Segment-based targeting**: Create campaigns that target specific audience segments.
- **File-based targeting**: Upload a CSV with phone numbers to target specific recipients.
- **Personalized messaging**: Send customized messages to each recipient (see [Personalized Campaigns](personalized-campaigns.md)).

## Campaign Labels

Campaigns support two types of label assignments:

1. **Campaign-specific label** (`campaignLabelName`): When creating a campaign, you can specify a custom label name that will be assigned to all conversations generated by this specific campaign.

2. **Shared campaign label** (`SHARED_CAMPAIGN_LABEL_ID`): All campaigns automatically receive a shared label defined by the `SHARED_CAMPAIGN_LABEL_ID` environment variable.

## Operational Flow

### Creating a Segment-Based Campaign

1. Define your campaign with:
   - Title (optional)
   - First message (required)
   - Second message (optional)
   - Message delay between first and second messages
   - Campaign label name (optional)
   - Run date and time (required, must be in the future)
   - Audience segments configuration (required)

2. Submit the campaign to the `/campaigns/` endpoint.

3. The system will validate your campaign configuration and store it in the database.

4. At the scheduled time, the campaign will be executed by the `check_and_run_campaigns` cron job.

### Creating a File-Based Campaign

1. Prepare a CSV file with phone numbers.

2. Define your campaign with the same fields as segment-based campaigns, but upload the CSV file instead of specifying segments.

3. Submit the campaign as a multipart form to the `/campaigns/` endpoint.

4. The system will validate your campaign, store the recipient file, and create the campaign record.

5. At the scheduled time, the campaign will be executed by the `check_and_run_campaigns` cron job.

### Campaign Execution

When a campaign is due to run:

1. The `check_and_run_campaigns` function identifies campaigns with a `run_at` time that matches the current time.

2. For segment-based campaigns, it processes the segment configuration to identify target recipients.

3. For file-based campaigns, it retrieves the list of phone numbers from the stored file.

4. It enqueues first messages for all recipients directly to the `broadcast_first_messages` queue.

5. If the campaign has a specified label (`campaignLabelName`), the system finds or creates this label in Missive.

6. All campaign conversations receive both the campaign-specific label (if specified) and the shared campaign label.

7. Messages are processed through the standard message sending pipeline described in the main [README](../README.md).

## API Reference

### Create Campaign

**POST /campaigns/**

Creates a new campaign with either segment-based or file-based targeting.

For segment-based campaigns:
```json
{
  "title": "Example Campaign",
  "firstMessage": "Hello! This is our first message.",
  "secondMessage": "Here's our follow-up message with more information.",
  "delay": 120,
  "campaignLabelName": "summer-campaign-2025",
  "runAt": 1679875200,
  "segments": {
    "included": [
      {
        "id": "550e8400-e29b-41d4-a716-446655440000",
        "since": 1678000000
      }
    ],
    "excluded": [
      {
        "id": "123e4567-e89b-12d3-a456-426614174000"
      }
    ]
  }
}
```

For file-based campaigns, submit a multipart form with:
- `title`: Campaign title
- `firstMessage`: First message content
- `secondMessage`: Follow-up message content (optional)
- `delay`: Delay in seconds between messages (optional)
- `campaignLabelName`: Label name to apply to campaign conversations (optional)
- `runAt`: Unix timestamp for when to run the campaign
- `file`: CSV file containing recipient phone numbers

### Get Campaigns

**GET /campaigns/**

Retrieves all campaigns, paginated and split into "upcoming" and "past" campaigns.

Query parameters:
- `page`: Page number (default: 1)
- `pageSize`: Number of items per page (default: 20)

### Update Campaign

**PATCH /campaigns/:id/**

Updates an existing campaign. Only future campaigns that haven't been processed can be updated.

Note: The `campaignLabelName` cannot be updated after campaign creation.

### Delete Campaign

**DELETE /campaigns/:id/**

Deletes an upcoming campaign. Only campaigns that haven't been processed can be deleted.


## Technical Details

- Campaigns are stored in the `campaigns` table.
- File-based campaign recipients are stored in the `campaign_file_recipients` table.
- Personalized campaign recipients are stored temporarily in the `campaign_personalized_recipients` table.
- The `labelId` field in the `campaigns` table stores the ID of the campaign-specific label.
- The `SHARED_CAMPAIGN_LABEL_ID` environment variable defines the label ID that is applied to all campaign messages.
- Message statuses for campaign messages are tracked in the `message_statuses` table.
